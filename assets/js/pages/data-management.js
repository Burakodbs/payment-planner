// Data Management page specific JavaScript code
// Sayfa y√ºklendiƒüinde ortak component'leri initialize et
document.addEventListener('DOMContentLoaded', function () {
    // Ortak component'leri initialize et
    if (typeof initializePage === 'function') {
        initializePage('data-yonetimi');
    }
});

function updateDataStats() {
    // ƒ∞statistikler cardƒ± kaldƒ±rƒ±ldƒ±, fonksiyon geriye uyumluluk i√ßin bo≈ü bƒ±rakƒ±ldƒ±
}

function updateCardAndUserManagement() {
    // Card management
    const cardList = document.getElementById('cardManagementList');
    if (cardList) {
        cardList.innerHTML = creditCards.map(card => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                <span>${card}</span>
                <div style="display: flex; gap: 4px;">
                    <button class="btn btn-sm btn-outline" onclick="editCard('${card}')">D√ºzenle</button>
                    <button class="btn btn-sm btn-danger" onclick="removeCard('${card}')">Sil</button>
                </div>
            </div>
        `).join('');
    }
    
    // User management
    const userList = document.getElementById('userManagementList');
    if (userList) {
        userList.innerHTML = people.map(person => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                <span>${person}</span>
                <div style="display: flex; gap: 4px;">
                    <button class="btn btn-sm btn-outline" onclick="editUser('${person}')">D√ºzenle</button>
                    <button class="btn btn-sm btn-danger" onclick="removeUser('${person}')">Sil</button>
                </div>
            </div>
        `).join('');
    }
}

// Card Management Functions
function addCard() {
    const input = document.getElementById('newCardName');
    const cardName = input.value.trim();
    
    if (!cardName) {
        showToast('‚ö†Ô∏è Kart adƒ± bo≈ü olamaz!', 'warning');
        return;
    }
    
    if (creditCards.includes(cardName)) {
        showToast('‚ö†Ô∏è Bu kart zaten mevcut!', 'warning');
        return;
    }
    
    creditCards.push(cardName);
    input.value = '';
    
    // Update UI
    updateCardAndUserManagement();
    if (typeof updateCardOptions === 'function') {
        updateCardOptions();
    }
    if (typeof authSystem !== 'undefined' && authSystem) {
        authSystem.saveUserData();
    }
    
    showToast('‚úÖ Kart ba≈üarƒ±yla eklendi!', 'success');
}

function editCard(oldCard) {
    const newCard = prompt('Yeni kart adƒ±:', oldCard);
    if (newCard && newCard.trim() && newCard.trim() !== oldCard) {
        const index = creditCards.indexOf(oldCard);
        if (index !== -1) {
            creditCards[index] = newCard.trim();
            
            // Update expenses that use this card
            if (typeof expenses !== 'undefined' && expenses) {
                expenses.forEach(expense => {
                    if (expense.card === oldCard) {
                        expense.card = newCard.trim();
                    }
                });
            }
            
            // Update UI
            updateCardAndUserManagement();
            if (typeof updateCardOptions === 'function') {
                updateCardOptions();
            }
            if (typeof authSystem !== 'undefined' && authSystem) {
                authSystem.saveUserData();
            }
            
            showToast('‚úÖ Kart ba≈üarƒ±yla g√ºncellendi!', 'success');
        }
    }
}

function removeCard(card) {
    if (confirm(`"${card}" kartƒ±nƒ± silmek istediƒüinizden emin misiniz?\n\nBu karta ait harcamalar silinmeyecek, ancak kart bilgisi kaldƒ±rƒ±lacak.`)) {
        const index = creditCards.indexOf(card);
        if (index !== -1) {
            creditCards.splice(index, 1);
            
            // Update UI
            updateCardAndUserManagement();
            if (typeof updateCardOptions === 'function') {
                updateCardOptions();
            }
            if (typeof authSystem !== 'undefined' && authSystem) {
                authSystem.saveUserData();
            }
            
            showToast('‚úÖ Kart ba≈üarƒ±yla silindi!', 'success');
        }
    }
}

// User Management Functions
function addUser() {
    const input = document.getElementById('newUserName');
    const userName = input.value.trim();
    
    if (!userName) {
        showToast('‚ö†Ô∏è Kullanƒ±cƒ± adƒ± bo≈ü olamaz!', 'warning');
        return;
    }
    
    if (people.includes(userName)) {
        showToast('‚ö†Ô∏è Bu kullanƒ±cƒ± zaten mevcut!', 'warning');
        return;
    }
    
    people.push(userName);
    input.value = '';
    
    // Update UI
    updateCardAndUserManagement();
    if (typeof updateUserOptions === 'function') {
        updateUserOptions();
    }
    if (typeof authSystem !== 'undefined' && authSystem) {
        authSystem.saveUserData();
    }
    
    showToast('‚úÖ Kullanƒ±cƒ± ba≈üarƒ±yla eklendi!', 'success');
}

function editUser(oldUser) {
    const newUser = prompt('Yeni kullanƒ±cƒ± adƒ±:', oldUser);
    if (newUser && newUser.trim() && newUser.trim() !== oldUser) {
        const index = people.indexOf(oldUser);
        if (index !== -1) {
            people[index] = newUser.trim();
            
            // Update expenses that use this user
            if (typeof expenses !== 'undefined' && expenses) {
                expenses.forEach(expense => {
                    if (expense.user === oldUser) {
                        expense.user = newUser.trim();
                    }
                });
            }
            
            // Update UI
            updateCardAndUserManagement();
            if (typeof updateUserOptions === 'function') {
                updateUserOptions();
            }
            if (typeof authSystem !== 'undefined' && authSystem) {
                authSystem.saveUserData();
            }
            
            showToast('‚úÖ Kullanƒ±cƒ± ba≈üarƒ±yla g√ºncellendi!', 'success');
        }
    }
}

function removeUser(user) {
    if (confirm(`"${user}" kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinizden emin misiniz?\n\nBu kullanƒ±cƒ±ya ait harcamalar silinmeyecek, ancak kullanƒ±cƒ± bilgisi kaldƒ±rƒ±lacak.`)) {
        const index = people.indexOf(user);
        if (index !== -1) {
            people.splice(index, 1);
            
            // Update UI
            updateCardAndUserManagement();
            if (typeof updateUserOptions === 'function') {
                updateUserOptions();
            }
            if (typeof authSystem !== 'undefined' && authSystem) {
                authSystem.saveUserData();
            }
            
            showToast('‚úÖ Kullanƒ±cƒ± ba≈üarƒ±yla silindi!', 'success');
        }
    }
}

// ==========================================
// DATA EXPORT/IMPORT FUNCTIONS
// ==========================================

/**
 * Export all data to JSON file - Integrated with FileStorage
 */
function exportData() {
    try {
        // Use FileStorage if available
        if (window.fileStorage && window.fileStorage.currentUser) {
            // FileStorage already handles backup file creation automatically
            // Force a manual save and backup
            window.fileStorage.saveUserData().then(() => {
                showToast('‚úÖ Yedek ba≈üarƒ±yla olu≈üturuldu ve indirildi!', 'success');
            }).catch((error) => {
                console.error('FileStorage export error:', error);
                fallbackExport();
            });
            return;
        }
        
        // Fallback to original export method
        fallbackExport();
    } catch (error) {
        console.error('‚ùå Export error:', error);
        showToast('‚ùå Yedek olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
    }
}

/**
 * Fallback export method (original localStorage-based)
 */
function fallbackExport() {
    try {
        // Collect all data
        const exportData = {
            expenses: expenses || [],
            regularPayments: regularPayments || [],
            creditCards: creditCards || [],
            people: people || [],
            exportDate: new Date().toISOString(),
            version: '3.1.0',
            appName: 'Payment Planner'
        };
        
        // Create backup filename with current date
        const currentDate = new Date().toISOString().slice(0, 10);
        const filename = `payment-planner-backup-${currentDate}.json`;
        
        // Convert to JSON string
        const jsonString = JSON.stringify(exportData, null, 2);
        
        // Create blob and download
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = filename;
        downloadLink.style.display = 'none';
        
        // Trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // Clean up
        URL.revokeObjectURL(url);
        
        // Show success message
        const totalRecords = (exportData.expenses.length + 
                            exportData.regularPayments.length + 
                            exportData.creditCards.length + 
                            exportData.people.length);
        showToast(`‚úÖ Yedek ba≈üarƒ±yla olu≈üturuldu!\nüìä ${totalRecords} toplam kayƒ±t\nüìÑ ${filename}`, 'success');
        
        console.log('Export completed:', {
            expenses: exportData.expenses.length,
            regularPayments: exportData.regularPayments.length,
            creditCards: exportData.creditCards.length,
            people: exportData.people.length,
            filename: filename
        });
    } catch (error) {
        console.error('‚ùå Export error:', error);
        showToast('‚ùå Yedek olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
    }
}

/**
 * Import data from JSON file - Integrated with FileStorage
 */
function importData() {
    try {
        // Create file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        
        fileInput.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate imported data
                    if (!validateImportedData(importedData)) {
                        showToast('‚ùå Ge√ßersiz veri formatƒ±!', 'error');
                        return;
                    }
                    
                    // Convert old format to new format if needed
                    const converted = convertLegacyData(importedData);
                    
                    // Ask user for confirmation
                    const message = `Bu i≈ülem mevcut verileri deƒüi≈ütirecek!\n\n` +
                                  `ƒ∞√ße aktarƒ±lacak veriler:\n` +
                                  `‚Ä¢ ${converted.expenses.length} harcama\n` +
                                  `‚Ä¢ ${converted.regularPayments.length} d√ºzenli √∂deme\n` +
                                  `‚Ä¢ ${converted.creditCards.length} kart\n` +
                                  `‚Ä¢ ${converted.people.length} ki≈üi\n\n` +
                                  `Devam edilsin mi?`;
                    
                    if (!confirm(message)) return;
                    
                    // Import data
                    if (window.fileStorage && window.fileStorage.currentUser) {
                        // Use FileStorage method
                        window.fileStorage.importBackupData(converted, file.name).then(() => {
                            showToast('‚úÖ Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±!', 'success');
                            setTimeout(() => {
                                if (confirm('Sayfayƒ± yenilemek t√ºm g√∂r√ºn√ºmleri g√ºncelleyecek. Devam edilsin mi?')) {
                                    window.location.reload();
                                }
                            }, 1000);
                        }).catch(error => {
                            console.error('FileStorage import error:', error);
                            fallbackImport(converted, file.name);
                        });
                    } else {
                        fallbackImport(converted, file.name);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Import parsing error:', error);
                    showToast('‚ùå Dosya okunamadƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        };
        
        // Trigger file dialog
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
        
    } catch (error) {
        console.error('‚ùå Import error:', error);
        showToast('‚ùå ƒ∞√ße aktarma ba≈ülatƒ±lamadƒ±: ' + error.message, 'error');
    }
}

/**
 * Fallback import method
 */
function fallbackImport(backupData, filename) {
    try {
        // Update global arrays
        window.expenses = backupData.expenses || [];
        window.regularPayments = backupData.regularPayments || [];
        window.creditCards = backupData.creditCards || [];
        window.people = backupData.people || [];
        
        // Update auth system if available
        if (typeof authSystem !== 'undefined' && authSystem) {
            authSystem.saveUserData();
        }
        
        const totalRecords = backupData.expenses.length + 
                           backupData.regularPayments.length + 
                           backupData.creditCards.length + 
                           backupData.people.length;
        
        showToast(`‚úÖ Veriler ba≈üarƒ±yla geri y√ºklendi!\nüìä ${totalRecords} kayƒ±t i√ße aktarƒ±ldƒ±\nüìÑ ${filename}`, 'success');
        
        console.log('Data restoration completed:', {
            expenses: backupData.expenses.length,
            regularPayments: backupData.regularPayments.length,
            creditCards: backupData.creditCards.length,
            people: backupData.people.length
        });
        
        // Reload page after a short delay to refresh all views
        setTimeout(() => {
            if (confirm('Sayfayƒ± yenilemek t√ºm g√∂r√ºn√ºmleri g√ºncelleyecek. Devam edilsin mi?')) {
                window.location.reload();
            }
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Data restoration error:', error);
        showToast('‚ùå Veri geri y√ºkleme hatasƒ±: ' + error.message, 'error');
    }
}

/**
 * Convert old data format to new format
 */
function convertLegacyData(importedData) {
    const converted = {
        expenses: [],
        regularPayments: [],
        creditCards: [],
        people: []
    };
    
    // Handle expenses
    converted.expenses = importedData.expenses || importedData.harcamalar || [];
    
    // Handle regular payments
    converted.regularPayments = importedData.regularPayments || importedData.duzenliOdemeler || [];
    
    // Handle credit cards
    converted.creditCards = importedData.creditCards || importedData.kartlar || [];
    
    // Handle people (kisiler -> people)
    converted.people = importedData.people || importedData.kisiler || [];
    
    console.log('Data conversion completed:', {
        expenses: converted.expenses.length,
        regularPayments: converted.regularPayments.length,
        creditCards: converted.creditCards.length,
        people: converted.people.length
    });
    
    return converted;
}

/**
 * Validate imported data
 */
function validateImportedData(data) {
    if (!data || typeof data !== 'object') return false;
    
    // Check if it has at least one of the expected properties
    const hasExpenses = Array.isArray(data.expenses) || Array.isArray(data.harcamalar);
    const hasPayments = Array.isArray(data.regularPayments) || Array.isArray(data.duzenliOdemeler);
    const hasCards = Array.isArray(data.creditCards) || Array.isArray(data.kartlar);
    const hasPeople = Array.isArray(data.people) || Array.isArray(data.kisiler);
    
    return hasExpenses || hasPayments || hasCards || hasPeople;
}

/**
 * Reset all data with confirmation
 */
function resetAllData() {
    const message = `‚ö†Ô∏è T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK!\n\n` +
                  `Bu i≈ülem:\n` +
                  `‚Ä¢ T√ºm harcamalarƒ±\n` +
                  `‚Ä¢ T√ºm d√ºzenli √∂demeleri\n` +
                  `‚Ä¢ T√ºm kartlarƒ±\n` +
                  `‚Ä¢ T√ºm ki≈üileri\n` +
                  `kalƒ±cƒ± olarak silecek.\n\n` +
                  `Bu i≈ülem GERƒ∞ ALINAMAZ!\n\n` +
                  `Devam etmek istediƒüinizden emin misiniz?`;
    
    if (!confirm(message)) return;
    
    // Second confirmation
    const finalConfirm = prompt('Onaylamak i√ßin "SIFIRLA" yazƒ±n:', '');
    if (finalConfirm !== 'SIFIRLA') {
        showToast('‚ùå ƒ∞≈ülem iptal edildi.', 'error');
        return;
    }
    
    try {
        // Reset all data
        window.expenses = [];
        window.regularPayments = [];
        window.creditCards = [];
        window.people = [];
        
        // Save changes
        if (typeof authSystem !== 'undefined' && authSystem) {
            authSystem.saveUserData();
        }
        
        showToast('‚úÖ T√ºm veriler ba≈üarƒ±yla sƒ±fƒ±rlandƒ±!', 'success');
        
        // Reload page after a short delay
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Reset error:', error);
        showToast('‚ùå Sƒ±fƒ±rlama hatasƒ±: ' + error.message, 'error');
    }
}
