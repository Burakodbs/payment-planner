// Data Management page specific JavaScript code

// Cloud sync fonksiyonlarƒ±
function setupCloudSync() {
    if (window.gistSync) {
        window.gistSync.setupWizard();
    } else {
        showToast('‚ùå Cloud sync mod√ºl√º y√ºklenemedi', 'error');
    }
}

function syncToCloud() {
    if (window.gistSync && window.gistSync.githubToken) {
        window.gistSync.syncToCloud().then(success => {
            if (success) {
                showToast('‚òÅÔ∏è Veriler cloud\'a y√ºklendi', 'success');
            } else {
                showToast('‚ùå Cloud upload hatasƒ±', 'error');
            }
        });
    } else {
        showToast('‚öôÔ∏è √ñnce cloud sync\'i kurun', 'warning');
    }
}

function syncFromCloud() {
    if (window.gistSync && window.gistSync.gistId) {
        window.gistSync.downloadFromGist().then(cloudData => {
            if (cloudData) {
                const confirmMessage = `‚òÅÔ∏è CLOUD\'DAN VERƒ∞ ƒ∞NDƒ∞RME\n\n` +
                                     `Cloud\'da bulunan veriler:\n` +
                                     `‚Ä¢ ${cloudData.expenses?.length || 0} harcama\n` +
                                     `‚Ä¢ ${cloudData.regularPayments?.length || 0} d√ºzenli √∂deme\n` +
                                     `‚Ä¢ ${cloudData.creditCards?.length || 0} kredi kartƒ±\n` +
                                     `‚Ä¢ ${cloudData.people?.length || 0} ki≈üi\n\n` +
                                     `Son g√ºncelleme: ${new Date(cloudData.lastUpdated).toLocaleString()}\n\n` +
                                     `‚ö†Ô∏è UYARI: Mevcut veriler silinecek!\n\n` +
                                     `Cloud\'dan indirmek istiyor musunuz?`;

                if (confirm(confirmMessage)) {
                    window.fileStorage.applyUserData(cloudData);
                    window.fileStorage.saveUserData();
                    showToast('‚òÅÔ∏è Cloud\'dan veriler indirildi', 'success');
                    setTimeout(() => updateCardAndUserManagement(), 500);
                }
            } else {
                showToast('‚ùå Cloud\'dan veri indirilemedi', 'error');
            }
        });
    } else {
        showToast('‚öôÔ∏è Cloud sync kurulumu gerekli', 'warning');
    }
}

function getCloudStatus() {
    if (!window.gistSync) {
        return 'Cloud sync mod√ºl√º y√ºklenemedi';
    }
    
    if (!window.gistSync.githubToken) {
        return '‚öôÔ∏è Kurulum gerekli - GitHub token yok';
    }
    
    if (!window.gistSync.gistId) {
        return 'üîÑ ƒ∞lk sync bekleniyor';
    }
    
    const lastSync = parseInt(localStorage.getItem('last_sync_time') || '0');
    if (lastSync === 0) {
        return 'üì§ Hen√ºz sync yapƒ±lmadƒ±';
    }
    
    const timeDiff = Date.now() - lastSync;
    const minutes = Math.floor(timeDiff / (1000 * 60));
    
    return `‚úÖ ${minutes} dakika √∂nce sync edildi`;
}

// Sayfa y√ºklendiƒüinde ortak component'leri initialize et
document.addEventListener('DOMContentLoaded', function () {
    // Ortak component'leri initialize et
    if (typeof initializePage === 'function') {
        initializePage('data-yonetimi');
    }
    
    // Cloud sync durumunu g√∂ster
    setTimeout(() => {
        const statusElement = document.getElementById('cloudSyncStatus');
        if (statusElement) {
            statusElement.textContent = getCloudStatus();
        }
    }, 1000);
});

function updateDataStats() {
    // ƒ∞statistikler cardƒ± kaldƒ±rƒ±ldƒ±, fonksiyon geriye uyumluluk i√ßin bo≈ü bƒ±rakƒ±ldƒ±
}

function updateCardAndUserManagement() {
    // Card management
    const cardList = document.getElementById('cardManagementList');
    if (cardList) {
        cardList.innerHTML = creditCards.map(card => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                <span>${card}</span>
                <div style="display: flex; gap: 4px;">
                    <button class="btn btn-sm btn-outline" onclick="editCard('${card}')">D√ºzenle</button>
                    <button class="btn btn-sm btn-danger" onclick="removeCard('${card}')">Sil</button>
                </div>
            </div>
        `).join('');
    }

    // Kullanƒ±cƒ± y√∂netimi
    const userList = document.getElementById('userManagementList');
    if (userList) {
        userList.innerHTML = people.map(person => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                <span>${person}</span>
                <div style="display: flex; gap: 4px;">
                    <button class="btn btn-sm btn-outline" onclick="editUser('${person}')">D√ºzenle</button>
                    <button class="btn btn-sm btn-danger" onclick="removeUser('${person}')">Sil</button>
                </div>
            </div>
        `).join('');
    }

    // D√ºzenli √∂deme form se√ßeneklerini g√ºncelle
    const regularCardSelect = document.getElementById('regularCard');
    const regularUserSelect = document.getElementById('regularUser');

    if (regularCardSelect) {
        // Mevcut se√ßenekleri clear(ilk option hari√ß)
        const options = regularCardSelect.querySelectorAll('option:not([value=""])');
        options.forEach(option => option.remove());

        // Yeni se√ßenekleri ekle
        creditCards.forEach(card => {
            const option = document.createElement('option');
            option.value = card;
            option.textContent = card;
            regularCardSelect.appendChild(option);
        });
    }

    if (regularUserSelect) {
        // Mevcut se√ßenekleri clear(ilk option hari√ß)
        const options = regularUserSelect.querySelectorAll('option:not([value=""])');
        options.forEach(option => option.remove());

        // Yeni se√ßenekleri ekle
        people.forEach(person => {
            const option = document.createElement('option');
            option.value = person;
            option.textContent = person;
            regularUserSelect.appendChild(option);
        });
    }
}

function addNewCard() {
    const input = document.getElementById('newCardInput');
    const cardName = input.value.trim();
    if (cardName && !creditCards.includes(cardName)) {
        creditCards.push(cardName);
        authSystem.saveUserData();
        updateCardOptions();
        updateCardAndUserManagement();
        input.value = '';
        showToast('Card successfully added', 'success');
    }
}

function addNewUser() {
    const input = document.getElementById('newUserInput');
    const userName = input.value.trim();
    if (userName && !people.includes(userName)) {
        people.push(userName);
        authSystem.saveUserData();
        updateUserOptions();
        updateCardAndUserManagement();
        input.value = '';
        showToast('Kullanƒ±cƒ± ba≈üarƒ±yla eklendi', 'success');
    }
}

function removeCard(cardName) {
    if (confirm(`"${cardName}" cardƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) {
        creditCards = creditCards.filter(k => k !== cardName);
        authSystem.saveUserData();
        updateCardOptions();
        updateCardAndUserManagement();
        showToast('Card deleted', 'success');
    }
}

function removeUser(userName) {
    if (confirm(`"${userName}" kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) {
        people = people.filter(k => k !== userName);
        authSystem.saveUserData();
        updateUserOptions();
        updateCardAndUserManagement();
        showToast('Kullanƒ±cƒ± silindi', 'success');
    }
}

// Manual migration function for data management page
function runManualMigration() {
    if (typeof migrateRegularPaymentData === 'function') {
        migrateRegularPaymentData();
    } else {
        showToast('Migration fonksiyonu bulunamadƒ±', 'error');
    }
}

// ==========================================
// BACKUP & RESTORE FUNCTIONS
// ==========================================

/**
 * Export all data to JSON file - Integrated with FileStorage
 */
function exportData() {
    try {
        console.log('üîÑ Starting data export with FileStorage integration...');
        
        // Use FileStorage if available
        if (window.fileStorage && window.fileStorage.currentUser) {
            // FileStorage already handles backup file creation automatically
            // Force a manual save and backup
            window.fileStorage.saveUserData().then(() => {
                showToast('‚úÖ Yedek ba≈üarƒ±yla olu≈üturuldu ve indirildi!', 'success');
            }).catch((error) => {
                console.error('FileStorage export error:', error);
                fallbackExport();
            });
            return;
        }
        
        // Fallback to original export method
        fallbackExport();
        
    } catch (error) {
        console.error('‚ùå Export error:', error);
        showToast('‚ùå Yedek olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
    }
}

/**
 * Fallback export method (original localStorage-based)
 */
function fallbackExport() {
    try {
        console.log('üîÑ Starting data export...');
        
        // Collect all data
        const exportData = {
            expenses: expenses || [],
            regularPayments: regularPayments || [],
            creditCards: creditCards || [],
            people: people || [],
            exportDate: new Date().toISOString(),
            version: '3.1.0',
            appName: 'Payment Planner'
        };

        // Create backup filename with current date
        const currentDate = new Date().toISOString().slice(0, 10);
        const filename = `payment-planner-backup-${currentDate}.json`;

        // Convert to JSON string
        const jsonString = JSON.stringify(exportData, null, 2);
        
        // Create blob and download
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = filename;
        downloadLink.style.display = 'none';
        
        // Trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // Clean up
        URL.revokeObjectURL(url);

        // Show success message
        const totalRecords = (exportData.expenses.length + 
                            exportData.regularPayments.length + 
                            exportData.creditCards.length + 
                            exportData.people.length);

        showToast(`‚úÖ Yedek ba≈üarƒ±yla olu≈üturuldu!\nüìä ${totalRecords} toplam kayƒ±t\nüìÅ ${filename}`, 'success');
        
        console.log(`‚úÖ Data exported successfully:`, {
            expenses: exportData.expenses.length,
            regularPayments: exportData.regularPayments.length,
            creditCards: exportData.creditCards.length,
            people: exportData.people.length,
            filename: filename
        });

    } catch (error) {
        console.error('‚ùå Export error:', error);
        showToast('‚ùå Yedek olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
    }
}

/**
 * Import data from JSON file - Integrated with FileStorage
 */
function importData() {
    try {
        console.log('üîÑ Starting data import process with FileStorage integration...');
        
        // Create file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) {
                showToast('‚ö†Ô∏è Dosya se√ßilmedi', 'warning');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.json')) {
                showToast('‚ùå L√ºtfen ge√ßerli bir JSON dosyasƒ± se√ßin', 'error');
                return;
            }

            try {
                // Use FileStorage if available
                if (window.fileStorage && window.fileStorage.currentUser) {
                    const success = await window.fileStorage.importFromFile(file);
                    if (success) {
                        showToast('‚úÖ Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±!', 'success');
                        // Update all views
                        setTimeout(() => {
                            updateCardAndUserManagement();
                            if (typeof DataManager !== 'undefined' && DataManager.updateAllViews) {
                                DataManager.updateAllViews();
                            }
                        }, 500);
                    }
                } else {
                    // Fallback to original import method
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            processImportedData(importedData, file.name);
                        } catch (parseError) {
                            console.error('‚ùå JSON parse error:', parseError);
                            showToast('‚ùå Ge√ßersiz JSON dosyasƒ±: ' + parseError.message, 'error');
                        }
                    };
                    
                    reader.onerror = function() {
                        showToast('‚ùå Dosya okuma hatasƒ±', 'error');
                    };
                    
                    reader.readAsText(file);
                }
                
            } catch (error) {
                console.error('‚ùå Import error:', error);
                showToast('‚ùå ƒ∞√ße aktarma hatasƒ±: ' + error.message, 'error');
            }
        });
        
        // Trigger file selection
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);

    } catch (error) {
        console.error('‚ùå Import initialization error:', error);
        showToast('‚ùå ƒ∞√ße aktarma ba≈ülatƒ±lƒ±rken hata olu≈ütu: ' + error.message, 'error');
    }
}

/**
 * Process and validate imported data
 */
function processImportedData(importedData, filename) {
    try {
        console.log('üîÑ Processing imported data from:', filename);
        console.log('üìä Raw imported data:', importedData);

        // Validate data structure
        if (!importedData || typeof importedData !== 'object') {
            throw new Error('Ge√ßersiz veri formatƒ±');
        }

        // Convert old Turkish field names to new English format if needed
        const convertedData = convertImportedDataFormat(importedData);
        
        // Validate converted data
        const validationResult = validateImportedData(convertedData);
        if (!validationResult.isValid) {
            throw new Error('Veri doƒürulama hatasƒ±: ' + validationResult.error);
        }

        // Show confirmation dialog
        const totalRecords = (convertedData.expenses?.length || 0) + 
                           (convertedData.regularPayments?.length || 0) + 
                           (convertedData.creditCards?.length || 0) + 
                           (convertedData.people?.length || 0);

        const confirmMessage = `üìÅ Dosya: ${filename}\n\nüìä ƒ∞√ße Aktarƒ±lacak Veriler:\n` +
                              `‚Ä¢ ${convertedData.expenses?.length || 0} harcama\n` +
                              `‚Ä¢ ${convertedData.regularPayments?.length || 0} d√ºzenli √∂deme\n` +
                              `‚Ä¢ ${convertedData.creditCards?.length || 0} kredi kartƒ±\n` +
                              `‚Ä¢ ${convertedData.people?.length || 0} ki≈üi\n\n` +
                              `‚ö†Ô∏è UYARI: Bu i≈ülem mevcut t√ºm verilerinizin yerine ge√ßer!\n\n` +
                              `Devam etmek istediƒüinizden emin misiniz?`;

        if (confirm(confirmMessage)) {
            restoreDataFromBackup(convertedData, filename);
        } else {
            showToast('üìã ƒ∞√ße aktarma iptal edildi', 'info');
        }

    } catch (error) {
        console.error('‚ùå Data processing error:', error);
        showToast('‚ùå Veri i≈üleme hatasƒ±: ' + error.message, 'error');
    }
}

/**
 * Convert imported data format (handle both old Turkish and new English formats)
 */
function convertImportedDataFormat(importedData) {
    console.log('üîÑ Converting data format...');
    
    const converted = {
        expenses: [],
        regularPayments: [],
        creditCards: [],
        people: []
    };

    // Handle expenses (harcamalar -> expenses)
    const expensesData = importedData.expenses || importedData.harcamalar || [];
    converted.expenses = expensesData.map(item => {
        // Handle null amounts
        const amount = (item.amount !== null && item.amount !== undefined) ? 
                      parseFloat(item.amount) : 
                      (item.tutar !== null && item.tutar !== undefined) ? 
                      parseFloat(item.tutar) : 0;

        return {
            id: item.id,
            date: item.date || item.tarih,
            card: item.card || item.kart,
            person: item.person || item.kullanici,
            category: item.category || item.kategori || 'Diƒüer',
            description: item.description || item.aciklama || '',
            amount: amount,
            installmentNumber: item.installmentNumber || item.taksitNo,
            totalInstallments: item.totalInstallments || item.toplamTaksit,
            isInstallment: item.isInstallment || item.isTaksit || false,
            regularPaymentId: item.regularPaymentId || item.duzenliOdemeId,
            isRegular: item.isRegular || false
        };
    });

    // Handle regular payments (duzenliOdemeler -> regularPayments)
    const regularPaymentsData = importedData.regularPayments || importedData.duzenliOdemeler || [];
    converted.regularPayments = regularPaymentsData.map(item => ({
        id: item.id,
        description: item.description || item.aciklama || item.ad,
        amount: parseFloat(item.amount || item.tutar) || 0,
        card: item.card || item.kart,
        person: item.person || item.kullanici,
        startDate: item.startDate || item.baslangicTarihi,
        category: item.category || item.kategori || 'Regular Payment',
        active: item.active !== false && item.aktif !== false // Default to true
    }));

    // Handle credit cards (kredikartlari -> creditCards)
    converted.creditCards = importedData.creditCards || importedData.kredikartlari || [];

    // Handle people (kisiler -> people)
    converted.people = importedData.people || importedData.kisiler || [];

    console.log('‚úÖ Data conversion completed:', {
        expenses: converted.expenses.length,
        regularPayments: converted.regularPayments.length,
        creditCards: converted.creditCards.length,
        people: converted.people.length
    });

    return converted;
}

/**
 * Validate imported data
 */
function validateImportedData(data) {
    try {
        // Check if data has required structure
        if (!data.expenses || !Array.isArray(data.expenses)) {
            return { isValid: false, error: 'Expenses data is missing or invalid' };
        }

        if (!data.regularPayments || !Array.isArray(data.regularPayments)) {
            return { isValid: false, error: 'Regular payments data is missing or invalid' };
        }

        if (!data.creditCards || !Array.isArray(data.creditCards)) {
            return { isValid: false, error: 'Credit cards data is missing or invalid' };
        }

        if (!data.people || !Array.isArray(data.people)) {
            return { isValid: false, error: 'People data is missing or invalid' };
        }

        // Validate expenses data structure
        for (let i = 0; i < Math.min(data.expenses.length, 3); i++) {
            const expense = data.expenses[i];
            if (!expense.id || !expense.date || !expense.card || !expense.person) {
                return { isValid: false, error: `Invalid expense structure at index ${i}` };
            }
        }

        return { isValid: true };

    } catch (error) {
        return { isValid: false, error: error.message };
    }
}

/**
 * Restore data from backup
 */
function restoreDataFromBackup(backupData, filename) {
    try {
        console.log('üîÑ Starting data restoration...');

        // Create backup of current data before restoring
        const currentDataBackup = {
            expenses: [...(expenses || [])],
            regularPayments: [...(regularPayments || [])],
            creditCards: [...(creditCards || [])],
            people: [...(people || [])]
        };

        // Update global variables
        window.expenses = backupData.expenses;
        window.regularPayments = backupData.regularPayments;
        window.creditCards = backupData.creditCards;
        window.people = backupData.people;

        // Save to localStorage
        localStorage.setItem('expenses', JSON.stringify(backupData.expenses));
        localStorage.setItem('regularPayments', JSON.stringify(backupData.regularPayments));
        localStorage.setItem('creditCards', JSON.stringify(backupData.creditCards));
        localStorage.setItem('people', JSON.stringify(backupData.people));

        // Save to auth system if available
        if (typeof authSystem !== 'undefined' && authSystem.currentUser) {
            authSystem.currentUserData = {
                ...authSystem.currentUserData,
                expenses: backupData.expenses,
                regularPayments: backupData.regularPayments,
                creditCards: backupData.creditCards,
                people: backupData.people
            };
            authSystem.saveUserData();
            console.log('‚úÖ Data saved to user account');
        }

        // Update all UI components
        if (typeof DataManager !== 'undefined' && DataManager.updateAllViews) {
            DataManager.updateAllViews();
        }

        updateCardAndUserManagement();

        const totalRecords = backupData.expenses.length + 
                           backupData.regularPayments.length + 
                           backupData.creditCards.length + 
                           backupData.people.length;

        showToast(`‚úÖ Veriler ba≈üarƒ±yla geri y√ºklendi!\nüìä ${totalRecords} kayƒ±t i√ße aktarƒ±ldƒ±\nüìÅ ${filename}`, 'success');

        console.log('‚úÖ Data restoration completed successfully:', {
            expenses: backupData.expenses.length,
            regularPayments: backupData.regularPayments.length,
            creditCards: backupData.creditCards.length,
            people: backupData.people.length
        });

        // Reload page after a short delay to refresh all views
        setTimeout(() => {
            if (confirm('Sayfayƒ± yeniden y√ºklemek t√ºm g√∂r√ºn√ºmleri g√ºncelleyecek. Devam edilsin mi?')) {
                window.location.reload();
            }
        }, 2000);

    } catch (error) {
        console.error('‚ùå Data restoration error:', error);
        showToast('‚ùå Veri geri y√ºkleme hatasƒ±: ' + error.message, 'error');
        
        // Try to restore from backup if available
        if (currentDataBackup) {
            console.log('üîÑ Attempting to restore previous data...');
            window.expenses = currentDataBackup.expenses;
            window.regularPayments = currentDataBackup.regularPayments;
            window.creditCards = currentDataBackup.creditCards;
            window.people = currentDataBackup.people;
        }
    }
}

/**
 * Emergency restore function - restore from hardcoded backup data - Integrated with FileStorage
 */
function emergencyRestore() {
    try {
        console.log('üö® Starting emergency data restore with FileStorage integration...');
        
        // Hardcoded backup data from the latest known backup
        const emergencyBackupData = {
            "expenses": [
                {"id":"duzenli_1754317509229_2025-08","date":"2025-08-05","card":"Vakƒ±f","person":"Burak","category":"D√ºzenli √ñdeme","description":"anne telefon (D√ºzenli)","amount":208,"installmentNumber":null,"totalInstallments":null,"isInstallment":false,"regularPaymentId":1754317509229,"isRegular":true},
                {"id":1754317386965,"date":"2025-08-04","card":"Ziraat","person":"Burak","category":"Diƒüer","description":"turknet berkay","amount":1000,"installmentNumber":1,"totalInstallments":6,"isInstallment":true},
                {"id":1754340317305,"date":"2025-08-04","card":"Vakƒ±f","person":"Burak","category":"Diƒüer","description":"","amount":75,"installmentNumber":null,"totalInstallments":null,"isInstallment":null},
                {"id":"duzenli_1754435023174_2025-08","date":"2025-08-03","card":"Vakƒ±f","person":"Burak","category":"D√ºzenli √ñdeme","description":"ihh (D√ºzenli)","amount":800,"installmentNumber":null,"totalInstallments":null,"isInstallment":false,"regularPaymentId":1754435023174,"isRegular":true}
            ],
            "regularPayments": [
                {"id":1754317509229,"description":"anne telefon","card":"Vakƒ±f","person":"Burak","amount":208,"startDate":"2025-08-05","category":"Regular Payment","active":true},
                {"id":1754317556140,"description":"anane telefon","card":"Vakƒ±f","person":"Burak","amount":308.5,"startDate":"2025-08-18","category":"Regular Payment","active":true},
                {"id":1754317577574,"description":"burak telefon","card":"Vakƒ±f","person":"Burak","amount":306,"startDate":"2025-08-12","category":"Regular Payment","active":true},
                {"id":1754435023174,"description":"ihh","amount":800,"card":"Vakƒ±f","person":"Burak","startDate":"2025-08-03","category":"Regular Payment","active":true}
            ],
            "creditCards": ["Axess", "World", "Enpara", "Vakƒ±f", "Ziraat"],
            "people": ["Burak", "Semih Abi", "Sinan Abi", "Annem", "Talha"]
        };

        const confirmMessage = `üö® ACƒ∞L VERƒ∞ KURTARMA\n\n` +
                              `Bu i≈ülem son bilinen yedek verileri geri y√ºkler:\n` +
                              `‚Ä¢ ${emergencyBackupData.expenses.length} harcama\n` +
                              `‚Ä¢ ${emergencyBackupData.regularPayments.length} d√ºzenli √∂deme\n` +
                              `‚Ä¢ ${emergencyBackupData.creditCards.length} kredi kartƒ±\n` +
                              `‚Ä¢ ${emergencyBackupData.people.length} ki≈üi\n\n` +
                              `‚ö†Ô∏è UYARI: Mevcut t√ºm veriler silinecek!\n\n` +
                              `Acil kurtarma i≈ülemini ba≈ülatmak istiyor musunuz?`;

        if (confirm(confirmMessage)) {
            // Use FileStorage if available
            if (window.fileStorage && window.fileStorage.currentUser) {
                // Convert to proper format for FileStorage
                const userData = {
                    username: window.fileStorage.currentUser,
                    lastUpdated: new Date().toISOString(),
                    expenses: emergencyBackupData.expenses,
                    regularPayments: emergencyBackupData.regularPayments,
                    creditCards: emergencyBackupData.creditCards,
                    people: emergencyBackupData.people,
                    settings: {
                        theme: 'light'
                    }
                };
                
                window.fileStorage.applyUserData(userData);
                window.fileStorage.saveUserData().then(() => {
                    showToast('üöë Acil veri kurtarma ba≈üarƒ±yla tamamlandƒ±!', 'success');
                    setTimeout(() => updateCardAndUserManagement(), 500);
                }).catch((error) => {
                    console.error('FileStorage emergency restore error:', error);
                    // Fallback to original method
                    restoreDataFromBackup(emergencyBackupData, 'Emergency Backup');
                });
            } else {
                // Fallback to original method
                restoreDataFromBackup(emergencyBackupData, 'Emergency Backup');
            }
            
            showToast('üöë Acil veri kurtarma i≈ülemi ba≈ülatƒ±ldƒ±!', 'success');
        } else {
            showToast('üö® Acil kurtarma iptal edildi', 'info');
        }

    } catch (error) {
        console.error('‚ùå Emergency restore error:', error);
        showToast('‚ùå Acil kurtarma hatasƒ±: ' + error.message, 'error');
    }
}